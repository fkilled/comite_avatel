<div style="text-align:center;">
  <h2>Calendario de Reuniones</h2>
  <p>Próximos eventos del Comité de Empresa (extraído de Google Calendar).</p>

  <div id="calendar-events" style="margin-top:20px;">
    <p>Cargando eventos...</p>
  </div>

  <button id="authorize-calendar-btn"
          style="background-color:#ffcc00;color:#7121D1;border:none;border-radius:6px;padding:10px 16px;font-weight:bold;cursor:pointer;margin-top:15px;">
    Conectar con Google Calendar
  </button>
</div>

<style>
  .event-card {
    display: flex;
    align-items: center;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    padding: 15px 20px;
    margin-bottom: 15px;
    transition: transform 0.2s;
  }
  .event-card:hover { transform: translateY(-3px); }

  .event-date {
    flex: 0 0 90px;
    text-align: center;
    margin-right: 20px;
    border-radius: 10px;
    padding: 10px;
    font-weight: bold;
    color: #fff;
    background-color: #7121D1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  .event-date span { font-size: 0.9rem; }

  .event-info {
    text-align: left;
  }
  .event-info strong { font-size: 1.1rem; }
  .event-info em { font-size: 0.9rem; color: #555; }

  .all-day { background-color: #C084FC !important; }
</style>

<script>
  // Configuración
  const CLIENT_ID = '50924464133-p08sk3tqmijmkvu6j38b754hqhvm2vpn.apps.googleusercontent.com';
  const CALENDAR_ID = 'comiteavatelmadrid@gmail.com';
  const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

  let tokenClient;
  let gapiInited = false;

  function gapiLoaded() {
    gapi.load('client', async () => {
      await gapi.client.init({
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
      });
      gapiInited = true;
      initGoogleCalendar();
      // Intentar cargar automáticamente si hay token previo
      if(gapi.client.getToken()) listUpcomingEvents();
    });
  }

  function initGoogleCalendar() {
    if(!tokenClient){
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (tokenResponse) => {
          if(tokenResponse.error){
            console.error(tokenResponse.error);
            return;
          }
          await listUpcomingEvents();
        }
      });
    }
  }

  function authorizeCalendar() {
    if(!tokenClient) initGoogleCalendar();
    tokenClient.requestAccessToken({ prompt: 'consent' });
  }

  async function listUpcomingEvents() {
    if(!gapiInited) {
      await gapiLoaded();
    }

    const response = await gapi.client.calendar.events.list({
      calendarId: CALENDAR_ID,
      timeMin: (new Date()).toISOString(),
      showDeleted: false,
      singleEvents: true,
      maxResults: 10,
      orderBy: 'startTime'
    });

    const container = document.getElementById('calendar-events');
    container.innerHTML = '';

    const events = response.result.items;
    if(!events || events.length === 0){
      container.innerHTML = '<p>No hay eventos próximos.</p>';
      return;
    }

    events.forEach(event => {
      const isAllDay = !!event.start.date;
      const start = new Date(event.start.dateTime || event.start.date);
      const day = start.getDate();
      const month = start.toLocaleString('es-ES', { month: 'short' });
      const year = start.getFullYear();
      const hours = start.getHours().toString().padStart(2,'0');
      const minutes = start.getMinutes().toString().padStart(2,'0');

      const card = document.createElement('div');
      card.className = 'event-card';

      const dateDiv = document.createElement('div');
      dateDiv.className = 'event-date' + (isAllDay ? ' all-day' : '');
      dateDiv.innerHTML = `${day}<span>${month}</span>`;

      const infoDiv = document.createElement('div');
      infoDiv.className = 'event-info';
      infoDiv.innerHTML = `<strong>${event.summary || 'Sin título'}</strong><br>
                           <em>${isAllDay ? 'Todo el día' : `${hours}:${minutes} - ${year}`}</em>`;

      card.appendChild(dateDiv);
      card.appendChild(infoDiv);
      container.appendChild(card);
    });
  }

  // Botón para autorizar manualmente
  document.getElementById('authorize-calendar-btn').addEventListener('click', () => {
    authorizeCalendar();
  });

  // Inicializamos gapi al cargar la página
  gapiLoaded();
</script>
